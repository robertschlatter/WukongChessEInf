<!--
Wukong Chess
Robert Schlatter, Matthew Hornstein, Leonardo Toker in Zusammenarbeit
Datum: 7.3.2023
Hauptquelle:  https://github.com/maksimKorzh/wukongJS.git
-->



<html>
{% load static %}  <!-- include static files like css and js in the html template -->
  <head>
    <title>WukongJS + Chessboardjs</title>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> <!-- Adds some js functionality -->

    <!-- Bootstrap for responsive web-design-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <!-- chessboardjs, files for the chessboard displayed on the website with its functionality-->
    <link rel="stylesheet" href="{% static 'PlayWukong/css/chessboard-1.0.0.min.css' %}">
    <script src="{% static 'PlayWukong/js/chessboard-1.0.0.min.js' %}"></script>

    <!-- own stylesheet, used for background styling, navbar styling -->
    <link rel="stylesheet" href="{% static 'PlayWukong/css/wukong_chessboardjs.css' %}">

    <!-- WukongJS chess engine, to play against and to validate moves-->
    <script src="{% static 'PlayWukong/js/wukong.js' %}"></script>

  </head>
  <body>


     <!-- Add navbar at the top -->
      <nav>
        <div class="navbar-left">
          <a href="{% url 'startScreenLobbyView' %}">Home</a>
          <!-- the following links lead to the sites where you can play against other players or the Wukong bot
           Note that the Lobby ID is always 1, this is for testing purposes and will later be dynamically generated-->
          <a href="{% url 'playWukongView' 1 %}">Play Wukong</a>
          <a href="{% url 'playPlayerView' 1 %}">Play Player</a>
          <a href="#">About</a>
        </div>
        <div class="navbar-right">
          <!-- if the user is logged in, the dropdown menu displays the logout link-->
          {% if user.is_authenticated %}
            <div class="dropdown"> <!-- dropdown menu -->
              <button class="dropbtn">{{ user.username }}</button>
              <div class="dropdown-content">
                <a href="{% url 'UserAdministrationLogoutView' %}">Logout</a>
              </div>
            </div>
          {% else %}
          <!-- If the user is not logged in the Dropdown menu displays the links to the register or login page -->
            <div class="dropdown"> <!-- dropdown menu -->
              <button class="dropbtn">Account</button>
              <div class="dropdown-content">
                <a href="{% url 'UserAdministrationLoginView' %}">Login</a>
                <a href="{% url 'UserAdministrationSignUpView' %}">Sign up</a>
              </div>
            </div>
          {% endif %}
        </div>
      </nav>

    <div class="col mt-5">
      <div class="row">
        <div align="center" class="col">
          <!-- <a class="btn btn-outline-success" href="https://github.com/maksimKorzh/wukongJS/blob/main/integration">Source Code</a> -->

          <!-- chess board view -->
          <div id="chessboard" class=" mb-2 mt-5" style="width: 700px;"></div>

           <!-- the game control buttons have been disabled and have been replaced with key presses (see lines 103-123) -->

          <!-- game controls -->
          <!-- <div class="row" style="width: 427px;"> -->
            <!-- -buttons -->
            <!-- <div class="col btn-group">
              <button id="newgame" class="btn btn-outline-secondary">New</button>
              <button id="makemove" class="btn btn-outline-secondary">Move</button>
              <button id="takeback" class="btn btn-outline-secondary">Undo</button>
              <button id="flipboard" class="btn btn-outline-secondary">Flip</button>
            </div>
          </div> -->
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  /****************************\
   ============================

        USER INPUT HANDLERS
   ============================
  \****************************/

  <!-- register key presses and carry out certain actions if needed -->
  $(document).on('keydown', function(event) {
    if(event.key == "m" || event.key == "M") {
      // make move
      makeMove();
    } else if(event.key == "b" || event.key == "B") {
      // take back move
      engine.takeBack();

      // update board position
      board.position(engine.generateFen());
    } else if(event.key == "f" || event.key == "F") {
      // flip board
      board.flip();
    } else if(event.key == "n" || event.key == "N") {
      // set board
      engine.setBoard(engine.START_FEN);

      // set initial board position
      board.position('start');
    }
  });

  <!-- the following section until the user control functions section is copied 1:1 from the main source listed at the top -->

  // handle select move time option
  $('#move_time').on('change', function() {
    // disable fixed depth
    $('#fixed_depth').val('0');
  });

  // handle select fixed depth option
  $('#fixed_depth').on('change', function() {
    // disable fixed depth
    $('#move_time').val('0');
  });

  // handle set FEN button click
  $('#set_fen').on('click', function() {
    // set user FEN

    // FEN parsed
    if (game.load($('#fen').val()))
      // set board position
      board.position(game.fen());

    // FEN is not parsed
    else
      alert('Illegal FEN!');
  });

  // prevent scrolling on touch devices
  $('#chessboard').on('scroll touchmove touchend touchstart contextmenu', function(e) {
    e.preventDefault();
  });


  /****************************\
   ============================

      USER CONTROL FUNCTIONS
   ============================
  \****************************/

  // make engine move
  function makeMove() {
    // make computer move
    setTimeout(function() {
      let bestMove = engine.searchTime(1000); // search for 1 second
      engine.makeMove(bestMove);
      //play move sound
      playGameSound(bestMove);
      let fen = engine.generateFen();
      board.position(fen);
      //check if game is over for the engine's opponent (stalemate/checkmate)
      //this function isn't fully functional for now, but will be extended in the near future. It can already detect stalemate and checkmate
      let gameOver = engine.isGameOver();
      if (gameOver > 0) {gameOverAnimation(gameOver);}
    }, 300);

  }

  // on dropping piece
  function onDrop (source, target) {
    let promotedPiece = (engine.getSide() ? (5 + 6): 5) // queen promotion only for now
    let move = source + target + engine.promotedToString(promotedPiece);
    let validMove = engine.moveFromString(move);

    //console.log('user move', promotedPiece);

    // invalid move
    if (validMove === 0) return 'snapback';

    //generate all legal moves in the position right now
    let legalMoves = engine.generateLegalMoves();
    let isLegal = 0;

    //check if the made move is among the valid moves
    for (let count = 0; count < legalMoves.length; count++) {
      if (validMove === legalMoves[count].move) isLegal = 1;
    }

    // illegal move --> take the move back
    if (isLegal === 0) return 'snapback'; //this triggers a function in the chessboard-1.0.0.min.js file which then takes the move back

    // make user move
    engine.makeMove(validMove);
    //play move sound
    playGameSound(validMove);
    //engine.printBoard();

    // TODO: update game status
    let gameOver = engine.isGameOver();

    if (!gameOver) {
      // make engine move
      makeMove(); //--> add makeMove() to play against engine, remove it to play against other players
    }
    else {
      gameOverAnimation(gameOver); //not implemented yet, just empty function
    }
  }

  // update the board position after the piece snap
  // for castling, en passant, pawn promotion
  function onSnapEnd () {
    board.position(engine.generateFen());
  }


  /****************************\
   ============================

           MAIN DRIVER
   ============================
  \****************************/
  // chess board configuration
  var config = {
    draggable: true,
    position: 'start',
    //onDragStart: onDragStart,
    onDrop: onDrop,
    onSnapEnd: onSnapEnd
  }

  // create chess board widget instance (from chessboard-1.0.0.min.css)
  var board = Chessboard('chessboard', config)

  // create WukongJS engine instance (from wukong.js)
  const engine = new Engine();

 /****************************\
 ============================

    OWN ADDED FUNCTIONS
 ============================
 \****************************/

 //audio for piece movement
 const moveMP3 = new Audio('/static/PlayWukong/mp3/move.mp3');
 const captureMP3 = new Audio('/static/PlayWukong/mp3/capture.mp3');

 //play capture or move sound
 function playGameSound(move){
   //check if the made move is a capture (with a function from wukong.js)
   if (engine.getMoveCapture(move)) {captureMP3.play();}
   else {moveMP3.play();}
 }

 function gameOverAnimation(type) {
   //type : 1 --> checkmate, 2 --> stalemate
   //side : 0 --> white, 1 --> black
   console.log(type,engine.getSide()) //for debugging
 }
</script>